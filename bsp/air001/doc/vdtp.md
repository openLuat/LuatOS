---
title: 虚拟设备文本协议
author: zozoh
---

# 虚拟设备文本协议概述

![](concept-overview.png)

通过本协议，虚拟设备与虚拟外设可以互相传送如下信息：

1. 虚拟设备的系统设置，包括：
   - 芯片类型
   - 各个管脚设置
   - Lua 源文件
2. 每个管脚的输入输出信息
3. 日志输出流
4. 开关机或者重启指令

通过本协议，希望达到如下效果：

1. 提供一个 B/S 架构虚拟设备运行系统
2. 在图形界面上直接输入 Lua 脚本，并可运行
3. 可以直接查看日志
4. 图形界面提供常用外设，譬如三色灯，温度传感器的模拟, 并可与虚拟设备协同工作
5. 如果在本系统运行正常的脚本，可直接烧录在对应硬件上，并正常工作
6. 本系统提供编译打包命令，可以直接将 Lua 脚本制作成 `bin` 文件让用户下载

# 逻辑结构

```bash
# 一个设备，两个管道
/vdev/$id/input     # 向虚拟模块输入（模块端订阅）
/vdev/$id/output    # 从虚拟模块流出（外设端订阅）
```

## 系统定义

![](chip-air302.png)

```bash
#---------------------------------------------
# 设备实例唯一 ID
id: "a4d..aq",
#---------------------------------------------
# 模块型号
type: "Air302"
#---------------------------------------------
# 管脚设置
# GPIO: 输入|输出|中断|防抖中断
# SPI_XXX: 开/关
pins: [{
  type        : [RESERVED],
  index       : 1
}, {
  type        : [SPI_CS, GPIO],
  number      : [1, 16],
  index       : 2,
  state       : 0,     # 不同的 type 理解不同
  value       : 0      # 寄存器值
}, {
  type        : [SPI_CLK, GPIO],
  number      : [1, 16],
  index       : 3,
  state       : 0,     # 不同的 type 理解不同
  value       : 0      # 寄存器值
}]
```

## 输入输出

```bash
#---------------------------------------------
# 设备实例唯一 ID
id: "a4d..aq",
#---------------------------------------------
# 模式
#  0 - 从管脚输出
#  1 - 向管脚输入
mode: 1
#---------------------------------------------
# 相关管脚（整数 1base）
pin    : 6
# 冗余
type   : GPIO,
nubmer : 2,
#---------------------------------------------
# 数据
# 数字脚： 0 或者 1
# 模拟脚:  0 ~ 1 的浮点数
value: [12,23,45,0]
```


## 日志

```bash
#---------------------------------------------
# 设备实例唯一 ID
id: "a4d..aq",
# 日志jibie 
leval: 2,
# 日志内容
text: "xxxxx"
```
