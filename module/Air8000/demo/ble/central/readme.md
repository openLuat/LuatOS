## 功能模块介绍

1、main.lua：主程序入口；

2、ble_client_main.lua：ble中心设备主程序，进行ble初始化，处理各类ble事件（连接、断开连接、扫描报告、GATT操作完成等）；

3、ble_client_receiver.lua：ble中心设备接收数据处理逻辑；

4、ble_client_sender.lua：ble中心设备发送数据处理逻辑；

5、ble_timer_app.lua：ble中心设备定时器处理逻辑，启动两个循环定时器，一个用于定时读取外围设备特征值UUID数据，一个用于定时向外围设备特征值UUID发送数据；

6、ble_uart_app.lua：ble中心设备接uart处理逻辑，将收到的notify数据，通过uart发送到pc端串口工具；

7、check_wifi.lua：检查当前Air8000模组的WiFi固件是否为最新版本，若不是则自动启动升级（需插入可联网的SIM卡）。

8、ble_lowpower.lua：控制WiFi和蓝牙的开启和关闭，默认WiFi和蓝牙都是开启状态，无需控制

## 用户消息介绍

1、"RECV_BLE_READ_DATA"：ble中心设备主动读取到外围设备特征值UUID数据时，会发布此消息，通知其他应用模块（如ble_uart_app）处理数据；

2、"RECV_BLE_NOTIFY_DATA"：ble中心设备收到外围设备特征值UUID的notify数据时，会发布此消息，通知其他应用模块（如ble_uart_app）处理数据；

3、"SEND_DATA_REQ"：其他应用模块（ble_timer_app）发布此消息，通知ble 中心设备发送publish数据给外围设备；

## 演示功能概述

使用Air8000核心板演示 ble的central(中心设备) 功能。

1、ble中心设备扫描并连接外围设备；

2、ble中心设备连接成功后，开始定时读取外围设备特征值UUID数据， 定时发送数据给外围设备；

3、ble中心设备收到外围设备特征值UUID的notify数据后，通过uart发送到pc端串口工具；

4、pc端串口工具收到数据后，打印到串口工具窗口。

## 演示硬件环境

1、Air8000核心板两块（本次演示中，一块作为中心设备，一块作为外围设备）

2、TYPE-C USB数据线一根

3、Air8000核心板和数据线的硬件接线方式为

- Air8000核心板通过TYPE-C USB口供电；（正常测试时核心板背面的功耗测试开关拨到ON，正面的白色拨码(供电,充电选择脚)开关拨到供电.）

- TYPE-C USB数据线直接插到核心板的TYPE-C USB座子，另外一端连接电脑USB口；

## 演示软件环境

1、[Luatools下载调试工具](https://docs.openluat.com/air8000/luatos/common/download/)

2、[Air8000 V2012版本固件](https://docs.openluat.com/air8000/luatos/firmware/)（理论上，2025年7月26日之后发布的固件都可以）

3、PC端的串口工具，例如SSCOM、LLCOM等都可以

## 演示核心步骤

1、搭建好硬件环境

2、Luatools烧录内核固件和修改后的demo脚本代码

作为中心设备的Air8000核心板，需要烧录central代码；

作为外围设备的Air8000核心板，需要烧录peripheral代码；

3、烧录成功后，自动开机运行，如果中心设备出现以下日志，表示中心设备连接外围设备成功

```lua
I/user.ble 发现目标设备: LuatOS
I/user.ble 停止扫描, 连接设备 C8C2C68D4FF6 0
```
4、如果中心设备出现以下日志，则表示GATT服务发现完成，此时中心设备便可以进行读/写/监听操作

```lua
I/user.ble gatt item table: 60C78190
I/user.ble gatt item table: 60C77F90
I/user.ble gatt item table: 60C77DB0
I/user.ble GATT服务发现完成
```
5、打开PC端的串口工具，选择对应的端口，配置波特率115200，数据位8，停止位1，无奇偶校验位；

6、在PC端的串口工具窗口中，会打印出中心设备监听到的外围设备notify数据；

```lua
-- 以下便是uart接收到的notify数据，数据格式为：服务UUID,特征值UUID,特征值数据
FA00,EA01,123456Thu Jan  1 08:00:25 1970
```
7、在luatools日志中可以看到中心设备主动写入外围设备指定特征值UUID的数据，以及向外围设备写入的结果。

```lua
-- 中心设备写入数据后，会有数据发送结果回调函数触发，下面打印的"true" 表示发送成功，timer后面的“1234”便是发送的数据。
I/user.send_data_cbfunc true timer1234
```

8、演示ble_lowpower.lua模块的功能

- 控制WiFi和蓝牙的开启和关闭

- 默认WiFi和蓝牙都是开启状态，无需控制

- 每300秒关闭一次WiFi，再开启一次WiFi

如果关闭了WiFi和蓝牙后，Luatools将打印”airlink slave timeout”，表示Air8000的4G部分和WiFi协处理器通信超时：

```lua
D/airlink slave timeout
```

下面是演示打开ble_lowpower模块后的日志：

```lua
[2026-01-23 15:03:26.782][000000000.241] D/airlink open airlink for air8000s
[2026-01-23 15:03:26.802][000000000.437] I/airlink AIRLINK_READY 437 version 18 t 240
[2026-01-23 15:03:26.811][000000000.438] D/airlink Air8000s启动完成, 等待了 195 ms
[2026-01-23 15:03:26.819][000000000.466] I/user.main project name is  ble_central version is  001.000.000
[2026-01-23 15:03:26.829][000000000.506] D/drv.bt 执行luat_bluetooth_init
[2026-01-23 15:03:26.843][000000000.517] Uart_ChangeBR 1461:uart1, 115200 115203 26000000 3611
[2026-01-23 15:03:26.863][000000000.598] I/user.BLE 扫描报告 | Type: 1 | MAC: 276C42E54AA4 | RSSI: -44 | Data: 1EFF0600010920220C5DE04CC1BD133C9B4A92CE075534EA1D9EC74B4E8AE9 
[2026-01-23 15:03:26.875][000000000.598] I/user.scan_param 1EFF0600010920220C5DE04CC1BD133C9B4A92CE075534EA1D9EC74B4E8AE9 62
[2026-01-23 15:03:26.947][000000000.619] I/user.BLE 扫描报告 | Type: 1 | MAC: 45C2A96D4E63 | RSSI: -58 | Data: 02010217FF8F031D1134384779103041A2011526290189570103020303AAFD 
[2026-01-23 15:03:26.958][000000000.620] I/user.scan_param 02010217FF8F031D1134384779103041A2011526290189570103020303AAFD 62
[2026-01-23 15:03:26.979][000000000.623] I/user.BLE 扫描报告 | Type: 1 | MAC: ED6A11223344 | RSSI: -55 | Data: 0201060303121803190000 
[2026-01-23 15:03:26.997][000000000.623] I/user.scan_param 0201060303121803190000 22
[2026-01-23 15:03:27.004][000000000.638] I/user.BLE 扫描报告 | Type: 0 | MAC: FCDF00016417 | RSSI: -77 | Data: 02010606096D6964656112FFA806013232303132373537414330313730 
[2026-01-23 15:03:27.014][000000000.638] I/user.scan_param 02010606096D6964656112FFA806013232303132373537414330313730 58
[2026-01-23 15:03:27.027][000000000.644] I/user.BLE 扫描报告 | Type: 0 | MAC: C8C2C68D97EC | RSSI: -45 | Data: 02010607094C7561744F53 
[2026-01-23 15:03:27.072][000000000.644] I/user.scan_param 02010607094C7561744F53 22
[2026-01-23 15:03:27.086][000000000.645] I/user.BLE 发现目标设备: LuatOS
[2026-01-23 15:03:27.102][000000000.645] I/user.ble 停止扫描, 连接设备 C8C2C68D97EC 0
[2026-01-23 15:03:27.200][000000000.649] I/user.BLE 扫描报告 | Type: 0 | MAC: E498BB061FA7 | RSSI: -74 | Data: 02010603020010 
[2026-01-23 15:03:27.224][000000000.649] I/user.scan_param 02010603020010 14
[2026-01-23 15:03:27.237][000000000.809] I/user.BLE 设备连接成功: C8C2C68D97EC
[2026-01-23 15:03:27.336][000000004.066] I/user.ble gatt item table: 0C7F1D98
[2026-01-23 15:03:27.342][000000004.068] I/user.ble gatt item table: 0C7F1B98
[2026-01-23 15:03:27.356][000000004.070] I/user.ble gatt item table: 0C7F19B8
[2026-01-23 15:03:27.370][000000004.072] I/airlink.bt gatt done, gatt total 3
[2026-01-23 15:03:27.380][000000004.073] I/user.BLE GATT服务发现完成
[2026-01-23 15:03:27.394][000000004.074] I/user.TIMER_APP 已启动发送数据循环定时器，间隔: 5000ms
[2026-01-23 15:03:27.405][000000004.074] I/user.TIMER_APP 已启动读取数据循环定时器，间隔: 5000ms
[2026-01-23 15:03:27.426][000000005.825] I/user.ble_client_receiver 收到通知数据 FA00 EA01 1 Fri Jan 23 15:03:25 2026
[2026-01-23 15:03:29.441][000000009.075] I/drv.ble luat_ble_read_value 执行完成
[2026-01-23 15:03:30.839][000000010.475] I/pm pm
[2026-01-23 15:03:30.856][000000010.475] I/user.ble_lowpower 发布: WiFi状态 -> 0
[2026-01-23 15:03:30.870][000000010.476] I/user.ble_server_main 收到WiFi状态变化: 0
[2026-01-23 15:03:30.884][000000010.477] E/user.ble_client_main_task_func 异常退出, 5秒后重新扫描连接
[2026-01-23 15:03:30.898][000000010.478] I/user.ble_server_main 等待5秒后重新尝试...
[2026-01-23 15:03:30.910][000000010.479] I/user.send_data_cbfunc false timer1234
[2026-01-23 15:03:30.924][000000010.479] I/user.TIMER_APP 已停止发送数据循环定时器
[2026-01-23 15:03:30.940][000000010.480] I/user.TIMER_APP 已停止读取数据循环定时器
[2026-01-23 15:03:31.845][000000011.481] D/airlink slave timeout
[2026-01-23 15:03:35.842][000000015.478] I/user.ble_server_main WiFi关闭，等待WiFi开启...
[2026-01-23 15:03:37.842][000000017.478] I/user.ble_server_main 等待5秒后重新尝试...
[2026-01-23 15:03:40.841][000000020.476] I/pm pm
[2026-01-23 15:03:40.849][000000020.476] I/user.ble_lowpower 发布: WiFi状态 -> 1
[2026-01-23 15:03:40.857][000000020.477] I/user.ble_server_main 收到WiFi状态变化: 1
[2026-01-23 15:03:42.841][000000022.478] D/drv.bt 执行luat_bluetooth_init
[2026-01-23 15:03:42.903][000000022.538] I/user.BLE 扫描报告 | Type: 1 | MAC: 276C42E54AA4 | RSSI: -45 | Data: 1EFF0600010920220C5DE04CC1BD133C9B4A92CE075534EA1D9EC74B4E8AE9 
[2026-01-23 15:03:42.916][000000022.539] I/user.scan_param 1EFF0600010920220C5DE04CC1BD133C9B4A92CE075534EA1D9EC74B4E8AE9 62
[2026-01-23 15:03:42.924][000000022.549] I/user.BLE 扫描报告 | Type: 1 | MAC: ED6A11223344 | RSSI: -53 | Data: 0201060303121803190000 
[2026-01-23 15:03:42.932][000000022.549] I/user.scan_param 0201060303121803190000 22
[2026-01-23 15:03:42.939][000000022.577] I/user.BLE 扫描报告 | Type: 0 | MAC: FCDF00016417 | RSSI: -77 | Data: 02010606096D6964656112FFA806013232303132373537414330313730 
[2026-01-23 15:03:42.949][000000022.577] I/user.scan_param 02010606096D6964656112FFA806013232303132373537414330313730 58
[2026-01-23 15:03:42.956][000000022.585] I/user.BLE 扫描报告 | Type: 1 | MAC: ED6A11223344 | RSSI: -55 | Data: 0201060303121803190000 
[2026-01-23 15:03:42.965][000000022.585] I/user.scan_param 0201060303121803190000 22
[2026-01-23 15:03:42.976][000000022.591] I/user.BLE 扫描报告 | Type: 0 | MAC: C8C2C68D97EC | RSSI: -45 | Data: 02010607094C7561744F53 
[2026-01-23 15:03:43.089][000000022.591] I/user.scan_param 02010607094C7561744F53 22
[2026-01-23 15:03:43.101][000000022.592] I/user.BLE 发现目标设备: LuatOS
[2026-01-23 15:03:43.113][000000022.592] I/user.ble 停止扫描, 连接设备 C8C2C68D97EC 0
[2026-01-23 15:03:43.183][000000022.754] I/user.BLE 设备连接成功: C8C2C68D97EC
[2026-01-23 15:03:46.380][000000026.016] I/user.ble gatt item table: 0C7EED18
[2026-01-23 15:03:46.399][000000026.019] I/user.ble gatt item table: 0C7EEB98
[2026-01-23 15:03:46.436][000000026.020] I/user.ble gatt item table: 0C7EEA38
[2026-01-23 15:03:46.451][000000026.021] I/airlink.bt gatt done, gatt total 3
[2026-01-23 15:03:46.464][000000026.023] I/user.BLE GATT服务发现完成
[2026-01-23 15:03:46.478][000000026.024] I/user.TIMER_APP 已启动发送数据循环定时器，间隔: 5000ms
[2026-01-23 15:03:46.492][000000026.025] I/user.TIMER_APP 已启动读取数据循环定时器，间隔: 5000ms
[2026-01-23 15:03:48.138][000000027.773] I/user.ble_client_receiver 收到通知数据 FA00 EA01 1 Fri Jan 23 15:03:47 2026
[2026-01-23 15:03:51.390][000000031.025] I/drv.ble luat_ble_read_value 执行完成
[2026-01-23 15:03:53.179][000000032.815] I/user.ble_client_receiver 收到通知数据 FA00 EA01 1 Fri Jan 23 15:03:52 2026
[2026-01-23 15:03:56.387][000000036.025] I/user.send_data_cbfunc true timer1234
[2026-01-23 15:03:56.397][000000036.026] I/drv.ble luat_ble_read_value 执行完成

```